name: Auto Delete Old Caches

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour at minute 0
  workflow_dispatch:  # Allows manual triggering for testing

jobs:
  delete-old-caches:
    runs-on: ubuntu-latest
    permissions:
      actions: write  # Required to delete caches
    steps:
      - name: Delete caches older than 1 day, but keep the 3 latest
        run: |
          # Get list of caches in JSON format
          caches=$(gh cache list --json id,key,createdAt --jq '.')
          
          # Sort by createdAt descending (newest first) and process
          echo "$caches" | jq -r 'sort_by(.createdAt) | reverse | to_entries[] | "\$.key) \$.value.id) \$.value.key) \$.value.createdAt)"' | while read -r index id key createdAt; do
            # Calculate age in days
            created_timestamp=$(date -d "$createdAt" +%s)
            now_timestamp=$(date +%s)
            age_days=$(( (now_timestamp - created_timestamp) / 86400 ))
            
            # Keep the 3 latest, delete others if older than 1 day
            if [ "$index" -lt 3 ]; then
              echo "Kept cache (among latest 3): $key (created: $createdAt)"
            elif [ "$age_days" -gt 1 ]; then
              gh cache delete "$id"
              echo "Deleted old cache: $key (created: $createdAt, age: $age_days days)"
            fi
          done
