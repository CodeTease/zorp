name: Kaboom Chaos Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  chaos-mode:
    name: Unleash Chaos
    runs-on: ubuntu-latest
    
    # We need Redis for Zorp to function properly
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      # 1. Setup Environment
      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python Deps
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      # 2. Build Zorp
      - name: Build Zorp (Release Mode)
        run: cargo build --release --features sqlite

      # 3. Prepare Docker (Busybox for the tests)
      - name: Pull Test Images
        run: docker pull busybox:latest
      
      # 4. Run Zorp in Background
      - name: Start Zorp Daemon
        env:
          ZORP_SECRET_KEY: "super-secret-ci-key"
          DATABASE_URL: "sqlite://zorp.db"
          REDIS_URL: "redis://localhost:6379"
          RUST_LOG: "info"
        run: |
          # Run in background & dump logs to file
          ./target/release/zorp > zorp.log 2>&1 &
          echo "Zorp started with PID $!"
          
          # Wait for port 3000 to be ready
          echo "Waiting for Zorp to wake up..."
          timeout 30s bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done'
          echo "Zorp is ALIVE!"

      # 5. Run The Chaos Script
      - name: Execute Chaos Script
        env:
          ZORP_SECRET_KEY: "super-secret-ci-key"
        run: |
          # Create .env file for python script since it uses load_dotenv
          echo "ZORP_SECRET_KEY=super-secret-ci-key" > .env
          
          echo "ðŸ”¥ Starting Chaos Test..."
          python test.py

      # 6. Post-Mortem (If failure)
      - name: Dump Zorp Logs
        if: always()
        run: |
          echo "=== ZORP LOGS ==="
          cat zorp.log
