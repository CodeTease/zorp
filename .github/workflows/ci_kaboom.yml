name: Kaboom Chaos Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  chaos-mode:
    name: Unleash Chaos
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      # 1. Setup Environment
      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python Deps
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      # 2. CACHE IS KING HERE 
      # Build release tá»‘n ráº¥t nhiá»u thá»i gian, cache lÃ  báº¯t buá»™c!
      - name: âš¡ Cache Cargo Registry & Release Target
        uses: Swatinem/rust-cache@v2
        with:
          key: "chaos-release-build"
          # Cache cáº£ target release Ä‘á»ƒ láº§n sau cháº¡y test nhanh nhÆ° giÃ³
          cache-targets: "true" 

      # 3. Build Zorp
      - name: Build Zorp (Release Mode)
        # Láº§n cháº¡y Ä‘áº§u tiÃªn sáº½ cháº­m, nhÆ°ng tá»« láº§n 2 sáº½ bay!
        run: cargo build --release --features sqlite

      # 4. Prepare Docker
      - name: Pull Test Images
        run: docker pull busybox:latest
      
      # 5. Run Zorp in Background
      - name: Start Zorp Daemon
        env:
          ZORP_SECRET_KEY: "super-secret-ci-key"
          DATABASE_URL: "sqlite://zorp.db"
          REDIS_URL: "redis://localhost:6379"
          RUST_LOG: "info"
        run: |
          ./target/release/zorp > zorp.log 2>&1 &
          echo "Zorp started with PID $!"
          
          echo "Waiting for Zorp to wake up..."
          timeout 30s bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done'
          echo "Zorp is ALIVE!"

      # 6. Run The Chaos Script
      - name: Execute Chaos Script
        env:
          ZORP_SECRET_KEY: "super-secret-ci-key"
        run: |
          echo "ZORP_SECRET_KEY=super-secret-ci-key" > .env
          echo "ðŸ”¥ Starting Chaos Test..."
          python test.py

      # 7. Post-Mortem
      - name: Dump Zorp Logs
        if: always()
        run: |
          echo "=== ZORP LOGS ==="
          cat zorp.log